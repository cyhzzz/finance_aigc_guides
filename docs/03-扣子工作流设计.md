# 扣子工作流设计指南

## 概述

扣子（Coze）的工作流功能可以实现复杂创作任务的自动化。通过节点连接、API接入和条件分支，构建可视化的执行流水线。

## 工作流基础

### 核心概念

**工作流**：将复杂任务拆解为一系列可自动执行的步骤

**节点**：工作流中的基本执行单元

**连线**：定义节点间的数据流转

**变量**：在节点间传递的数据

### 基本结构

```
开始 → 数据获取 → AI处理 → 格式化输出 → 结束
```

## 常用节点类型

### 1. 开始节点

工作流的入口，接收用户输入。

```yaml
输入变量:
  - 股票代码: string
  - 分析维度: string (技术面/基本面/资金面)
```

### 2. API调用节点

调用外部API获取数据。

**示例：获取股票行情**

```
节点名称：获取实时行情
API地址：https://api.example.com/stock/quote
请求方法：GET
参数：
  - code: {{股票代码}}
输出变量：stock_data
```

### 3. AI对话节点

使用AI处理和分析数据。

```
节点名称：生成分析报告
系统提示词：你是一位资深投资分析师...
输入：{{stock_data}}
输出变量：analysis_report
```

### 4. 代码节点

执行自定义代码逻辑。

```javascript
// 示例：计算涨跌幅
const change = ((current - previous) / previous) * 100;
return {
  change_percent: change.toFixed(2),
  trend: change > 0 ? '上涨' : '下跌'
};
```

### 5. 条件分支节点

根据条件执行不同路径。

```
条件：涨跌幅 > 0
- 是：生成乐观分析
- 否：生成风险提示
```

### 6. 循环节点

批量处理多个项目。

```
循环：股票列表
  - 获取每只股票数据
  - 生成分析
  - 添加到报告
结束循环
```

## 实战案例

### 案例1：市场热点分析工作流

**功能**：自动分析今日市场热点

```
流程图：

[开始]
  ↓
[获取今日涨跌幅榜] (API节点)
  ↓
[提取领涨板块] (代码节点)
  ↓
[检索相关新闻] (搜索节点)
  ↓
[生成热点解读] (AI节点)
  ↓
[格式化输出] (代码节点)
  ↓
[结束]
```

**详细配置**：

**节点1：获取市场数据**
```
API: https://api.example.com/market/summary
输出: market_data
```

**节点2：提取热点板块**
```javascript
const sectors = market_data.sectors;
const top = sectors
  .sort((a, b) => b.change_pct - a.change_pct)
  .slice(0, 5);
return { hot_sectors: top };
```

**节点3：AI解读**
```
提示词：分析以下热点板块的投资逻辑
输入：{{hot_sectors}}
输出：sector_analysis
```

**节点4：格式化**
```javascript
return {
  title: "今日市场热点分析",
  date: new Date().toLocaleDateString(),
  content: sector_analysis,
  tags: ["市场分析", "热点"]
};
```

### 案例2：智能选股工作流

**功能**：根据条件筛选股票

```
流程图：

[开始：接收筛选条件]
  ↓
[获取股票池] (API节点)
  ↓
[循环：每只股票]
  ↓
[检查条件] (分支节点)
  ├─ 符合 → [添加到结果]
  └─ 不符合 → [跳过]
  ↓
[生成选股报告] (AI节点)
  ↓
[结束]
```

**条件配置示例**：

```javascript
// 技术指标筛选
const ma5 = data.ma5;
const ma20 = data.ma20;
const volume = data.volume;

// 条件：金叉且放量
const is_golden_cross = ma5 > ma20;
const is_high_volume = volume > avg_volume * 1.5;

return is_golden_cross && is_high_volume;
```

### 案例3：内容生成+发布工作流

**功能**：自动生成并发布小红书内容

```
流程图：

[开始：输入主题]
  ↓
[检索知识库] (知识库节点)
  ↓
[生成初稿] (AI节点1)
  ↓
[风格适配] (AI节点2)
  ↓
[生成配图提示] (AI节点3)
  ↓
[输出完整内容] (代码节点)
  ↓
[结束]
```

**AI节点配置**：

**节点1：内容创作**
```
系统提示词：申万宏源投教笔记人格
任务：基于检索到的知识库内容，生成800字笔记
```

**节点2：风格适配**
```
系统提示词：小红书爆款风格
任务：将初稿改写为小红书格式
```

**节点3：配图生成**
```
任务：生成适合的配图描述
用于：DALL-E/Midjourney生成图片
```

## 高级技巧

### 1. 变量引用

在工作流中引用变量：

```
基础引用：{{变量名}}
嵌套引用：{{对象.属性}}
默认值：{{变量名 | 默认值}}
```

### 2. 错误处理

设置错误处理策略：

```
节点配置：
- 失败重试：3次
- 超时时间：30秒
- 失败时：跳过/终止/使用默认值
```

### 3. 并行执行

同时执行多个节点：

```
     [A]
    ↙  ↘
  [B]  [C]
    ↘  ↙
     [D]
```

### 4. 数据持久化

保存中间结果：

```javascript
// 保存到数据库
const result = await saveToDatabase({
  workflow_id: workflow.id,
  data: processed_data,
  timestamp: Date.now()
});
```

## API集成

### 常用API

**行情数据API**
- 新浪财经：免费基础数据
- 东方财富：详细行情数据
- Tushare：专业金融数据

**新闻资讯API**
- 百度新闻：实时新闻聚合
- 今日头条：热点资讯
- 财联社：专业财经快讯

**示例：接入行情API**

```javascript
const fetch = require('node-fetch');

async function getStockQuote(code) {
  const response = await fetch(
    `https://api.example.com/stock/${code}`
  );
  const data = await response.json();

  return {
    name: data.name,
    price: data.price,
    change: data.change,
    changePercent: data.change_percent
  };
}
```

## 工作流模板

### 模板1：数据分析型

```
[输入] → [获取数据] → [数据处理] →
[AI分析] → [生成报告] → [输出]
```

### 模板2：内容生成型

```
[输入主题] → [检索知识] → [生成内容] →
[风格优化] → [质量检查] → [输出]
```

### 模板3：自动监控型

```
[定时触发] → [获取数据] → [条件判断] →
[符合条件] → [发送通知] → [记录日志]
```

## 最佳实践

### 1. 模块化设计

将复杂工作流拆分为子工作流：

```
主工作流
├── 数据获取子流程
├── 分析处理子流程
└── 输出生成子流程
```

### 2. 参数配置

将可变参数提取为配置：

```javascript
const config = {
  // 可调整参数
  top_n: 5,
  threshold: 0.02,
  retry_times: 3,

  // 固定参数
  api_key: "xxx",
  model: "gpt-4"
};
```

### 3. 日志记录

添加详细日志便于调试：

```javascript
console.log(`[${timestamp}] 开始处理：${input}`);
console.log(`[${timestamp}] API返回：${data}`);
console.log(`[${timestamp}] 处理完成：${output}`);
```

### 4. 性能优化

- 使用并行处理提升效率
- 设置合理的超时时间
- 缓存重复数据
- 批量处理降低API调用

## 测试与调试

### 1. 单节点测试

单独测试每个节点：

```
测试输入：模拟数据
预期输出：标准结果
实际输出：实际结果
对比差异：调试问题
```

### 2. 端到端测试

完整测试工作流：

```
测试用例1：正常输入
测试用例2：边界情况
测试用例3：异常数据
```

### 3. 调试工具

- 查看节点执行日志
- 检查变量传递
- 验证数据格式
- 分析性能瓶颈

## 部署与发布

### 1. 版本管理

```
v1.0 - 初始版本
v1.1 - 优化数据处理
v1.2 - 新增功能
v2.0 - 重大升级
```

### 2. 权限设置

- 公开/私有
- 使用次数限制
- 调用频率限制
- 数据访问权限

### 3. 监控告警

```
监控指标：
- 执行成功率
- 平均执行时间
- 错误类型分布
- 资源使用情况

告警规则：
- 失败率 > 10%
- 耗时 > 30秒
- API错误 > 5次/小时
```

## 常见问题

**Q: 工作流执行失败怎么办？**

A:
1. 检查节点配置
2. 查看错误日志
3. 验证API连接
4. 测试单个节点

**Q: 如何提升执行速度？**

A:
1. 减少不必要的节点
2. 使用并行执行
3. 优化API调用
4. 启用缓存

**Q: 可以循环调用自己吗？**

A: 不支持递归调用，但可以通过循环节点实现迭代。

## 进阶学习

1. **官方文档**：coze.com/docs
2. **社区案例**：浏览优秀工作流
3. **实践项目**：从简单到复杂
4. **交流分享**：加入用户社群

持续学习和实践是掌握工作流的关键！
